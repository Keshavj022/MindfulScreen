{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h2 class="mb-4"><i class="fas fa-user-shield me-2"></i>Privacy & Data Settings</h2>

            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-download me-2"></i>Export Your Data</h5>
                </div>
                <div class="card-body">
                    <p>Download a complete copy of all your data in JSON format. This includes your profile, personality assessments, and session summaries.</p>
                    <button class="btn btn-primary" onclick="exportData()">
                        <i class="fas fa-file-download me-2"></i>Export Data
                    </button>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-trash-alt me-2"></i>Delete Session Data</h5>
                </div>
                <div class="card-body">
                    <p>Delete all your screen recording sessions and analysis data. Your account and profile will remain intact.</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone. All session data will be permanently deleted.
                    </div>
                    <button class="btn btn-warning" onclick="confirmDeleteSessions()">
                        <i class="fas fa-trash me-2"></i>Delete All Sessions
                    </button>
                </div>
            </div>

            <div class="card mb-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-user-times me-2"></i>Delete Account</h5>
                </div>
                <div class="card-body">
                    <p>Permanently delete your account and all associated data, including:</p>
                    <ul>
                        <li>Profile information</li>
                        <li>Personality assessment results</li>
                        <li>All screen recording sessions</li>
                        <li>All captured frames (encrypted)</li>
                        <li>Analysis data and knowledge graphs</li>
                    </ul>
                    <div class="alert alert-danger">
                        <i class="fas fa-skull-crossbones me-2"></i>
                        <strong>WARNING:</strong> This action is PERMANENT and IRREVERSIBLE. All your data will be securely deleted within 72 hours.
                    </div>
                    <button class="btn btn-danger" onclick="confirmDeleteAccount()">
                        <i class="fas fa-user-times me-2"></i>Delete My Account Permanently
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Data Privacy Information</h5>
                </div>
                <div class="card-body">
                    <h6><i class="fas fa-lock me-2"></i>How We Protect Your Data:</h6>
                    <ul>
                        <li><strong>Encryption:</strong> All captured frames are encrypted using AES-256</li>
                        <li><strong>Local Storage:</strong> Data stored securely on our servers, not sold to third parties</li>
                        <li><strong>Auto-Deletion:</strong> Frames older than 30 days are automatically deleted</li>
                        <li><strong>Secure Transmission:</strong> All data sent over HTTPS with TLS encryption</li>
                        <li><strong>Access Control:</strong> Only you can access your data</li>
                    </ul>

                    <h6 class="mt-4"><i class="fas fa-share-alt me-2"></i>Third-Party Data Sharing:</h6>
                    <p>We only share data with:</p>
                    <ul>
                        <li><strong>OpenAI:</strong> Screen frames sent for AI analysis (see <a href="https://openai.com/privacy" target="_blank">OpenAI Privacy</a>)</li>
                        <li><strong>Legal Authorities:</strong> When required by law</li>
                    </ul>

                    <p class="mt-3">
                        <a href="{{ url_for('privacy.policy') }}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-file-alt me-2"></i>Read Full Privacy Policy
                        </a>
                        <a href="{{ url_for('privacy.terms') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-file-contract me-2"></i>Terms of Service
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmSessionDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Session Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete all your session data?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="deleteSessions()">Delete Sessions</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmAccountDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-skull-crossbones me-2"></i>Confirm Account Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>This will permanently delete your account and ALL data.</strong></p>
                <p>Type <strong>DELETE</strong> to confirm:</p>
                <input type="text" id="deleteConfirmInput" class="form-control" placeholder="Type DELETE">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteAccount()">Permanently Delete Account</button>
            </div>
        </div>
    </div>
</div>

<script>
let sessionDeleteModal, accountDeleteModal;

document.addEventListener('DOMContentLoaded', () => {
    sessionDeleteModal = new bootstrap.Modal(document.getElementById('confirmSessionDeleteModal'));
    accountDeleteModal = new bootstrap.Modal(document.getElementById('confirmAccountDeleteModal'));
});

async function exportData() {
    try {
        const response = await fetch('/privacy/export-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });

        const data = await response.json();

        if (data.success) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mindfulscreen_data_${new Date().toISOString()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('Your data has been exported successfully!');
        } else {
            alert('Error exporting data: ' + data.error);
        }
    } catch (error) {
        alert('Error exporting data. Please try again.');
    }
}

function confirmDeleteSessions() {
    sessionDeleteModal.show();
}

async function deleteSessions() {
    try {
        const response = await fetch('/privacy/delete-sessions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });

        const data = await response.json();

        if (data.success) {
            sessionDeleteModal.hide();
            alert('All session data has been deleted successfully!');
            window.location.reload();
        } else {
            alert('Error deleting sessions: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting sessions. Please try again.');
    }
}

function confirmDeleteAccount() {
    document.getElementById('deleteConfirmInput').value = '';
    accountDeleteModal.show();
}

function deleteAccount() {
    const input = document.getElementById('deleteConfirmInput').value;

    if (input !== 'DELETE') {
        alert('Please type DELETE to confirm account deletion.');
        return;
    }

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/privacy/delete-account';

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = '{{ csrf_token() }}';
    form.appendChild(csrfInput);

    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
